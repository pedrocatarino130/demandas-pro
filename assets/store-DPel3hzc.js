import{f as r,a as c,b as h}from"./index-Ac05Oo_z.js";class b{constructor(){this.state=this.getDefaultState(),this.subscribers=[],this.saveDebounce=null,this.DEBOUNCE_DELAY=300,this.initialized=!1,this.initializing=!1,this.listeners=[],this.userId="default",this.init()}async init(){if(this.initializing)return;this.initializing=!0,await r.init();const t=await this.loadFromCache();if(t&&(this.state={...this.getDefaultState(),...t},this.notify()),await this.migrateFromV2(),c.isAvailable())try{await this.loadFromFirestore(),this.setupRealtimeListeners(),console.log("✅ Store inicializado (modo Firebase + local)")}catch(s){console.error("⚠️ Erro ao inicializar Firebase no Store:",s),console.log("✅ Store inicializado (modo local apenas)")}else console.log("✅ Store inicializado (modo local)");this.initialized=!0,this.initializing=!1}getDefaultState(){return{tarefas:[],contador:0,tarefasHome:[],contadorHome:0,tarefasRotina:[],contadorRotina:0,historico:[],categorias:[],areasEstudo:[],topicosEstudo:[],sessoesEstudo:[],contadorEstudos:0,tagsEstudo:[],configEstudos:{revisaoEspacada:{ativo:!0,intervalos:[7,15,30]},notificacoes:!0,viewPadrao:"kanban"},streak:0,conquistas:{},avaliacoesDiarias:[],darkMode:!1,filtroStatus:null,diaAtual:new Date().toISOString().split("T")[0],ultimaAtualizacao:new Date().toISOString()}}async loadFromCache(){try{const t=await r.get("store-state");if(t&&typeof t=="object")return{...this.getDefaultState(),...t}}catch(t){console.warn("Erro ao carregar estado do cache:",t)}return null}async loadFromFirestore(){if(c.isAvailable())try{const t=[{collection:"tarefas",stateKey:"tarefas"},{collection:"tarefasRotina",stateKey:"tarefasRotina"},{collection:"historico",stateKey:"historico"},{collection:"categorias",stateKey:"categorias"},{collection:"areasEstudo",stateKey:"areasEstudo"},{collection:"topicosEstudo",stateKey:"topicosEstudo"},{collection:"sessoesEstudo",stateKey:"sessoesEstudo"},{collection:"tagsEstudo",stateKey:"tagsEstudo"},{collection:"avaliacoesDiarias",stateKey:"avaliacoesDiarias"}],s={};for(const{collection:e,stateKey:a}of t)try{const i=await c.getCollection(e,[],"_lastModified","desc");i&&i.length>0&&(s[a]=i)}catch(i){console.warn(`Erro ao carregar coleção ${e}:`,i)}try{const e=await c.getDocument("configEstudos","default");e&&(s.configEstudos=e)}catch(e){console.warn("Erro ao carregar configEstudos:",e)}Object.keys(s).length>0&&(this.state={...this.state,...s},await r.set("store-state",this.state),console.log("✅ Dados carregados do Firestore"),this.notify())}catch(t){console.error("Erro ao carregar do Firestore:",t)}}saveToFirestore(){this.saveDebounce&&clearTimeout(this.saveDebounce),this.saveDebounce=setTimeout(async()=>{try{const t={...this.state,ultimaAtualizacao:new Date().toISOString()};await r.set("store-state",t),c.isAvailable()&&await this._saveCollectionsToFirestore(t)}catch(t){console.error("Erro ao salvar estado:",t)}},this.DEBOUNCE_DELAY)}async _saveCollectionsToFirestore(t){if(c.isAvailable())try{const s=[{stateKey:"tarefas",collection:"tarefas"},{stateKey:"tarefasRotina",collection:"tarefasRotina"},{stateKey:"historico",collection:"historico"},{stateKey:"categorias",collection:"categorias"},{stateKey:"areasEstudo",collection:"areasEstudo"},{stateKey:"topicosEstudo",collection:"topicosEstudo"},{stateKey:"sessoesEstudo",collection:"sessoesEstudo"},{stateKey:"tagsEstudo",collection:"tagsEstudo"},{stateKey:"avaliacoesDiarias",collection:"avaliacoesDiarias"}],e=[];for(const{stateKey:a,collection:i}of s){const u=t[a];Array.isArray(u)&&u.forEach(l=>{l&&l.id&&e.push({type:"UPDATE",collection:i,docId:l.id,data:l})})}if(t.configEstudos&&e.push({type:"UPDATE",collection:"configEstudos",docId:"default",data:t.configEstudos}),e.length>0)if(h.getOnlineStatus())try{await c.batchWrite(e)}catch(a){console.warn("Erro ao sincronizar imediatamente, adicionando à fila:",a);for(const i of e)await h.addToQueue(i)}else for(const a of e)await h.addToQueue(a)}catch(s){console.error("Erro ao salvar coleções no Firestore:",s)}}setupRealtimeListeners(){if(c.isAvailable())try{this.destroy(),[{collection:"tarefas",stateKey:"tarefas"},{collection:"tarefasRotina",stateKey:"tarefasRotina"},{collection:"historico",stateKey:"historico"},{collection:"categorias",stateKey:"categorias"},{collection:"areasEstudo",stateKey:"areasEstudo"},{collection:"topicosEstudo",stateKey:"topicosEstudo"},{collection:"sessoesEstudo",stateKey:"sessoesEstudo"},{collection:"tagsEstudo",stateKey:"tagsEstudo"},{collection:"avaliacoesDiarias",stateKey:"avaliacoesDiarias"}].forEach(({collection:e,stateKey:a})=>{const i=c.subscribeToCollection(e,u=>{Array.isArray(u)&&(this.state[a]=u,r.set("store-state",this.state).catch(l=>{console.error("Erro ao salvar no cache após atualização remota:",l)}),this.notify())},[]);this.listeners.push(i)});const s=c.subscribeToDocument("configEstudos","default",e=>{e&&(this.state.configEstudos=e,r.set("store-state",this.state).catch(a=>{console.error("Erro ao salvar config no cache:",a)}),this.notify())});this.listeners.push(s),console.log("✅ Listeners real-time configurados")}catch(t){console.error("Erro ao configurar listeners real-time:",t)}}async runMigration(){}async migrateFromV2(){try{if(await r.get("firestore-migrated"))return;const s="tarefas_projetos_v2",e="tarefas_rotina_v5",a="historico_rotina_v5",i="categorias_rotina_v4",u="estudos_dados_v2",l="avaliacoes_diarias_v1",m="gerenciador_v3_state";let n=!1;const f=localStorage.getItem(s);if(f)try{this.state.tarefas=JSON.parse(f),n=!0}catch(o){console.warn("Erro ao migrar projetos:",o)}const d=localStorage.getItem(e);if(d)try{this.state.tarefasRotina=JSON.parse(d),n=!0}catch(o){console.warn("Erro ao migrar rotina:",o)}const g=localStorage.getItem(a);if(g)try{this.state.historico=JSON.parse(g),n=!0}catch(o){console.warn("Erro ao migrar histórico:",o)}const E=localStorage.getItem(i);if(E)try{this.state.categorias=JSON.parse(E),n=!0}catch(o){console.warn("Erro ao migrar categorias:",o)}const y=localStorage.getItem(u);if(y)try{const o=JSON.parse(y);this.state.areasEstudo=o.areas||[],this.state.topicosEstudo=o.topicos||[],this.state.sessoesEstudo=o.sessoes||[],this.state.tagsEstudo=o.tags||[],o.config&&(this.state.configEstudos={...this.state.configEstudos,...o.config}),n=!0}catch(o){console.warn("Erro ao migrar estudos:",o)}const S=localStorage.getItem(l);if(S)try{this.state.avaliacoesDiarias=JSON.parse(S),n=!0}catch(o){console.warn("Erro ao migrar avaliações:",o)}const v=localStorage.getItem(m);if(v)try{const o=JSON.parse(v);this.state={...this.state,...o},n=!0}catch(o){console.warn("Erro ao migrar estado v3:",o)}if(n){await this.saveToFirestore(),this.saveDebounce&&clearTimeout(this.saveDebounce);const o={...this.state,ultimaAtualizacao:new Date().toISOString()};await r.set("store-state",o)}await r.set("firestore-migrated",!0),n&&(console.log("✅ Migração v2/v3 concluída"),this.notify())}catch(t){console.error("Erro na migração:",t)}}subscribe(t){return this.subscribers.push(t),()=>{this.subscribers=this.subscribers.filter(s=>s!==t)}}notify(){this.subscribers.forEach(t=>{try{t(this.state)}catch(s){console.error("Erro ao notificar subscriber:",s)}})}setState(t){this.state={...this.state,...t},this.saveToFirestore(),this.notify()}getState(){return{...this.state}}getStateSlice(t){return this.state[t]}updateStateSlice(t,s){const e=this.state[t];Array.isArray(e)?this.setState({[t]:[...e,...s]}):typeof e=="object"&&e!==null?this.setState({[t]:{...e,...s}}):this.setState({[t]:s})}addItem(t,s){const e=this.state[t];Array.isArray(e)&&this.setState({[t]:[...e,s]})}removeItem(t,s){const e=this.state[t];Array.isArray(e)&&this.setState({[t]:e.filter(a=>!s(a))})}updateItem(t,s,e){const a=this.state[t];Array.isArray(a)&&this.setState({[t]:a.map(i=>s(i)?{...i,...e}:i)})}async forceSave(){this.saveDebounce&&clearTimeout(this.saveDebounce);try{const t={...this.state,ultimaAtualizacao:new Date().toISOString()};await r.set("store-state",t)}catch(t){console.error("Erro ao forçar salvamento:",t)}}destroy(){this.listeners.forEach(t=>t()),this.listeners=[]}}const w=new b;export{w as s};
//# sourceMappingURL=store-DPel3hzc.js.map
