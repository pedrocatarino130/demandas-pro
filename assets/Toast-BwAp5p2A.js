const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/migrate-localStorage-to-firebase-DBoqDX6d.js","assets/firebase-service-DlA8zRSG.js","assets/firebase-DLTXyntu.js","assets/firebase-cache-CNydOCth.js","assets/idb-Dob3nYDb.js"])))=>i.map(i=>d[i]);
import{_ as b}from"./index-DoxFM99G.js";import{f as n}from"./firebase-service-DlA8zRSG.js";import{f as l}from"./firebase-cache-CNydOCth.js";class y{constructor(){this.state=this.getDefaultState(),this.subscribers=[],this.saveDebounce=null,this.DEBOUNCE_DELAY=300,this.initialized=!1,this.initializing=!1,this.listeners=[],this.userId="default",this.init()}async init(){await l.init();const t=await this.loadFromCache();t&&(this.state={...this.getDefaultState(),...t},this.notify()),await this.loadFromFirestore(),this.runMigration(),this.setupRealtimeListeners(),this.initialized=!0,console.log("✅ Store inicializado com Firebase")}getDefaultState(){return{tarefas:[],contador:0,tarefasHome:[],contadorHome:0,tarefasRotina:[],contadorRotina:0,historico:[],categorias:[],areasEstudo:[],topicosEstudo:[],sessoesEstudo:[],contadorEstudos:0,tagsEstudo:[],configEstudos:{revisaoEspacada:{ativo:!0,intervalos:[7,15,30]},notificacoes:!0,viewPadrao:"kanban"},streak:0,conquistas:{},avaliacoesDiarias:[],darkMode:!1,filtroStatus:null,diaAtual:new Date().toISOString().split("T")[0],ultimaAtualizacao:new Date().toISOString()}}async loadFromCache(){try{const t=await l.get("store-state");if(t&&typeof t=="object")return{...this.getDefaultState(),...t}}catch(t){console.warn("Erro ao carregar estado do cache:",t)}return null}async loadFromFirestore(){try{if(!n.isAvailable()){console.warn("Firestore não disponível, usando cache apenas");return}const[t,a,o,e,i]=await Promise.all([n.getCollection("tarefas"),n.getDocument("rotina",this.userId),n.getCollection("categorias"),n.getDocument("estudos",this.userId),n.getDocument("config",this.userId)]),s={...this.getDefaultState()};Array.isArray(t)&&(t.forEach(c=>{c.tipo==="projeto"?s.tarefas.push(c):c.tipo==="home"&&s.tarefasHome.push(c)}),s.contador=s.tarefas.length,s.contadorHome=s.tarefasHome.length),a&&(s.tarefasRotina=a.tarefasRotina||[],s.contadorRotina=a.contadorRotina||0,s.historico=a.historico||[]),Array.isArray(o)&&(s.categorias=o),e&&(s.areasEstudo=e.areasEstudo||[],s.topicosEstudo=e.topicosEstudo||[],s.sessoesEstudo=e.sessoesEstudo||[],s.contadorEstudos=e.contadorEstudos||0,s.tagsEstudo=e.tagsEstudo||[],e.configEstudos&&(s.configEstudos={...s.configEstudos,...e.configEstudos})),i&&(s.streak=i.streak||0,s.conquistas=i.conquistas||{},s.avaliacoesDiarias=i.avaliacoesDiarias||[],s.darkMode=i.darkMode||!1,s.filtroStatus=i.filtroStatus||null,i.diaAtual&&(s.diaAtual=i.diaAtual),i.ultimaAtualizacao&&(s.ultimaAtualizacao=i.ultimaAtualizacao)),this.state=s,await l.set("store-state",s),this.notify()}catch(t){console.error("Erro ao carregar estado do Firestore:",t)}}saveToFirestore(){this.saveDebounce&&clearTimeout(this.saveDebounce),this.saveDebounce=setTimeout(async()=>{try{const t={...this.state,ultimaAtualizacao:new Date().toISOString()};await l.set("store-state",t),n.isAvailable()&&await this._saveCollectionsToFirestore(t)}catch(t){console.error("Erro ao salvar estado no Firestore:",t)}},this.DEBOUNCE_DELAY)}async _saveCollectionsToFirestore(t){try{const a=[],o=[...t.tarefas.map(e=>({...e,tipo:"projeto"})),...t.tarefasHome.map(e=>({...e,tipo:"home"}))];for(const e of o)e.id&&a.push({type:"set",collection:"tarefas",docId:e.id,data:e,merge:!0});a.push({type:"set",collection:"rotina",docId:this.userId,data:{tarefasRotina:t.tarefasRotina,contadorRotina:t.contadorRotina,historico:t.historico,updatedAt:new Date().toISOString()},merge:!0});for(const e of t.categorias)e.id&&a.push({type:"set",collection:"categorias",docId:e.id,data:e,merge:!0});a.push({type:"set",collection:"estudos",docId:this.userId,data:{areasEstudo:t.areasEstudo,topicosEstudo:t.topicosEstudo,sessoesEstudo:t.sessoesEstudo,contadorEstudos:t.contadorEstudos,tagsEstudo:t.tagsEstudo,configEstudos:t.configEstudos,updatedAt:new Date().toISOString()},merge:!0}),a.push({type:"set",collection:"config",docId:this.userId,data:{streak:t.streak,conquistas:t.conquistas,avaliacoesDiarias:t.avaliacoesDiarias,darkMode:t.darkMode,filtroStatus:t.filtroStatus,diaAtual:t.diaAtual,ultimaAtualizacao:t.ultimaAtualizacao,updatedAt:new Date().toISOString()},merge:!0}),a.length>0&&await n.batchWrite(a)}catch(a){throw console.error("Erro ao salvar coleções no Firestore:",a),a}}setupRealtimeListeners(){if(!n.isAvailable())return;const t=n.subscribeToCollection("tarefas",s=>{const c=s.filter(u=>u.tipo==="projeto"),h=s.filter(u=>u.tipo==="home");this.state.tarefas=c,this.state.tarefasHome=h,this.state.contador=c.length,this.state.contadorHome=h.length,this.notify()});this.listeners.push(t);const a=n.subscribeToDocument("rotina",this.userId,s=>{s&&(this.state.tarefasRotina=s.tarefasRotina||[],this.state.contadorRotina=s.contadorRotina||0,this.state.historico=s.historico||[],this.notify())});this.listeners.push(a);const o=n.subscribeToCollection("categorias",s=>{this.state.categorias=s,this.notify()});this.listeners.push(o);const e=n.subscribeToDocument("estudos",this.userId,s=>{s&&(this.state.areasEstudo=s.areasEstudo||[],this.state.topicosEstudo=s.topicosEstudo||[],this.state.sessoesEstudo=s.sessoesEstudo||[],this.state.contadorEstudos=s.contadorEstudos||0,this.state.tagsEstudo=s.tagsEstudo||[],s.configEstudos&&(this.state.configEstudos={...this.state.configEstudos,...s.configEstudos}),this.notify())});this.listeners.push(e);const i=n.subscribeToDocument("config",this.userId,s=>{s&&(this.state.streak=s.streak||0,this.state.conquistas=s.conquistas||{},this.state.avaliacoesDiarias=s.avaliacoesDiarias||[],this.state.darkMode=s.darkMode||!1,this.state.filtroStatus=s.filtroStatus||null,s.diaAtual&&(this.state.diaAtual=s.diaAtual),s.ultimaAtualizacao&&(this.state.ultimaAtualizacao=s.ultimaAtualizacao),this.notify())});this.listeners.push(i)}async runMigration(){try{const{migrateLocalStorageToFirebase:t,createBackup:a}=await b(async()=>{const{migrateLocalStorageToFirebase:o,createBackup:e}=await import("./migrate-localStorage-to-firebase-DBoqDX6d.js");return{migrateLocalStorageToFirebase:o,createBackup:e}},__vite__mapDeps([0,1,2,3,4]));await a(),await t()}catch(t){console.error("Erro ao executar migração:",t),this.migrateFromV2()}}async migrateFromV2(){try{if(await l.get("firestore-migrated"))return;const a="tarefas_projetos_v2",o="tarefas_rotina_v5",e="historico_rotina_v5",i="categorias_rotina_v4",s="estudos_dados_v2",c="avaliacoes_diarias_v1",h="gerenciador_v3_state";let u=!1;const d=localStorage.getItem(a);if(d)try{this.state.tarefas=JSON.parse(d),u=!0}catch(r){console.warn("Erro ao migrar projetos:",r)}const f=localStorage.getItem(o);if(f)try{this.state.tarefasRotina=JSON.parse(f),u=!0}catch(r){console.warn("Erro ao migrar rotina:",r)}const g=localStorage.getItem(e);if(g)try{this.state.historico=JSON.parse(g),u=!0}catch(r){console.warn("Erro ao migrar histórico:",r)}const m=localStorage.getItem(i);if(m)try{this.state.categorias=JSON.parse(m),u=!0}catch(r){console.warn("Erro ao migrar categorias:",r)}const E=localStorage.getItem(s);if(E)try{const r=JSON.parse(E);this.state.areasEstudo=r.areas||[],this.state.topicosEstudo=r.topicos||[],this.state.sessoesEstudo=r.sessoes||[],this.state.tagsEstudo=r.tags||[],r.config&&(this.state.configEstudos={...this.state.configEstudos,...r.config}),u=!0}catch(r){console.warn("Erro ao migrar estudos:",r)}const p=localStorage.getItem(c);if(p)try{this.state.avaliacoesDiarias=JSON.parse(p),u=!0}catch(r){console.warn("Erro ao migrar avaliações:",r)}const S=localStorage.getItem(h);if(S)try{const r=JSON.parse(S);this.state={...this.state,...r},u=!0}catch(r){console.warn("Erro ao migrar estado v3:",r)}u&&(await this.saveToFirestore(),this.saveDebounce&&clearTimeout(this.saveDebounce),await this._saveCollectionsToFirestore(this.state)),await l.set("firestore-migrated",!0),u&&(console.log("✅ Migração v2/v3 → Firestore concluída"),this.notify())}catch(t){console.error("Erro na migração:",t)}}subscribe(t){return this.subscribers.push(t),()=>{this.subscribers=this.subscribers.filter(a=>a!==t)}}notify(){this.subscribers.forEach(t=>{try{t(this.state)}catch(a){console.error("Erro ao notificar subscriber:",a)}})}setState(t){this.state={...this.state,...t},this.saveToFirestore(),this.notify()}getState(){return{...this.state}}getStateSlice(t){return this.state[t]}updateStateSlice(t,a){const o=this.state[t];Array.isArray(o)?this.setState({[t]:[...o,...a]}):typeof o=="object"&&o!==null?this.setState({[t]:{...o,...a}}):this.setState({[t]:a})}addItem(t,a){const o=this.state[t];Array.isArray(o)&&this.setState({[t]:[...o,a]})}removeItem(t,a){const o=this.state[t];Array.isArray(o)&&this.setState({[t]:o.filter(e=>!a(e))})}updateItem(t,a,o){const e=this.state[t];Array.isArray(e)&&this.setState({[t]:e.map(i=>a(i)?{...i,...o}:i)})}async forceSave(){this.saveDebounce&&clearTimeout(this.saveDebounce);try{const t={...this.state,ultimaAtualizacao:new Date().toISOString()};await l.set("store-state",t),n.isAvailable()&&await this._saveCollectionsToFirestore(t)}catch(t){console.error("Erro ao forçar salvamento:",t)}}destroy(){this.listeners.forEach(t=>t()),this.listeners=[]}}const T=new y;class A{constructor(){this.toasts=[],this.container=null,this.init()}init(){this.container=document.createElement("div"),this.container.className="toast-container",this.container.id="toast-container",document.body.appendChild(this.container)}show(t,a={}){const{type:o="info",duration:e=5e3,action:i=null,actionLabel:s="Desfazer"}=a,c=document.createElement("div");return c.className=`toast toast-${o}`,c.innerHTML=`
      <span class="toast-message">${this.escapeHtml(t)}</span>
      ${i?`<button class="toast-action" data-action-id="${this.toasts.length}">${this.escapeHtml(s)}</button>`:""}
      <button class="toast-close" aria-label="Fechar">×</button>
    `,this.container.appendChild(c),setTimeout(()=>{c.classList.add("toast-show")},10),i&&c.querySelector(".toast-action").addEventListener("click",()=>{i(),this.hide(c)}),c.querySelector(".toast-close").addEventListener("click",()=>{this.hide(c)}),e>0&&setTimeout(()=>{this.hide(c)},e),this.toasts.push({element:c,action:i}),c}hide(t){t&&(t.classList.remove("toast-show"),t.classList.add("toast-hide"),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t),this.toasts=this.toasts.filter(a=>a.element!==t)},300))}success(t,a={}){return this.show(t,{...a,type:"success"})}error(t,a={}){return this.show(t,{...a,type:"error"})}info(t,a={}){return this.show(t,{...a,type:"info"})}escapeHtml(t){const a=document.createElement("div");return a.textContent=t,a.innerHTML}}const _=new A;export{T as s,_ as t};
//# sourceMappingURL=Toast-BwAp5p2A.js.map
