import{f as a}from"./firebase-service-DlA8zRSG.js";import{f as r}from"./firebase-cache-CNydOCth.js";import"./firebase-DLTXyntu.js";import"./idb-Dob3nYDb.js";class n{constructor(){this.state={areas:[],topicos:[],contadorAreas:0,contadorTopicos:0,versao:3},this.subscribers=[],this.revisaoEspacada=null,this.userId="default",this.initialized=!1,this.listeners=[],this.saveDebounce=null,this.DEBOUNCE_DELAY=300,this.init()}async init(){await r.init();const t=await r.get("estudos-store-state");t&&(this.state={...this.state,...t},this._notify()),await this._loadFromFirestore(),await this._migrateFromV2(),this._setupListeners(),this.initialized=!0,console.log("âœ… EstudosStore inicializado com Firebase")}async _loadFromFirestore(){try{if(!a.isAvailable())return;const t=await a.getDocument("estudos",this.userId);if(t){const s=t.areasEstudo||[],e=t.topicosEstudo||[];this.state.areas=s,this.state.topicos=e,this.state.contadorAreas=s.length,this.state.contadorTopicos=e.length,await r.set("estudos-store-state",this.state),this._notify()}}catch(t){console.error("Erro ao carregar estudos do Firestore:",t)}}_saveToFirestore(){this.saveDebounce&&clearTimeout(this.saveDebounce),this.saveDebounce=setTimeout(async()=>{try{await r.set("estudos-store-state",this.state),a.isAvailable()&&await a.setDocument("estudos",this.userId,{areasEstudo:this.state.areas,topicosEstudo:this.state.topicos,contadorEstudos:this.state.contadorTopicos,updatedAt:new Date().toISOString()},!0)}catch(t){console.error("Erro ao salvar estudos no Firestore:",t)}},this.DEBOUNCE_DELAY)}_setupListeners(){if(!a.isAvailable())return;const t=a.subscribeToDocument("estudos",this.userId,s=>{if(s){const e=s.areasEstudo||[],o=s.topicosEstudo||[];this.state.areas=e,this.state.topicos=o,this.state.contadorAreas=e.length,this.state.contadorTopicos=o.length,r.set("estudos-store-state",this.state),this._notify()}});this.listeners.push(t)}async _migrateFromV2(){try{if(await r.get("estudos-firestore-migrated"))return;const e=localStorage.getItem("estudos_v2");if(e&&this.state.areas.length===0&&this.state.topicos.length===0){const o=JSON.parse(e);o.areas&&Array.isArray(o.areas)&&(this.state.areas=o.areas.map(i=>({id:i.id||`area_${Date.now()}_${Math.random()}`,nome:i.nome,descricao:i.descricao||"",cor:i.cor||"#3b82f6",icone:i.icone||"ðŸ“š",status:i.status||"ativo",criadoEm:i.criadoEm||new Date().toISOString()}))),o.topicos&&Array.isArray(o.topicos)&&(this.state.topicos=o.topicos.map(i=>({id:i.id||`topico_${Date.now()}_${Math.random()}`,titulo:i.titulo,descricao:i.descricao||"",areaId:i.areaId,status:i.status||"NÃ£o iniciado",prioridade:i.prioridade||"MÃ©dia",tags:i.tags||[],tempoEstimado:i.tempoEstimado||null,sessoes:i.sessoes||[],proximaRevisao:i.proximaRevisao||null,ultimaRevisao:i.ultimaRevisao||null,historicoRevisoes:i.historicoRevisoes||[],concluidoEm:i.concluidoEm||null,criadoEm:i.criadoEm||new Date().toISOString()}))),this.state.contadorAreas=this.state.areas.length,this.state.contadorTopicos=this.state.topicos.length,await this._saveToFirestore(),this.saveDebounce&&clearTimeout(this.saveDebounce),await a.setDocument("estudos",this.userId,{areasEstudo:this.state.areas,topicosEstudo:this.state.topicos,contadorEstudos:this.state.contadorTopicos,updatedAt:new Date().toISOString()},!0),await r.set("estudos-firestore-migrated",!0),this._notify(),console.log("âœ… MigraÃ§Ã£o de dados v2 concluÃ­da")}}catch(t){console.warn("Erro na migraÃ§Ã£o v2",t)}}subscribe(t){return this.subscribers.push(t),()=>{this.subscribers=this.subscribers.filter(s=>s!==t)}}_notify(){this.subscribers.forEach(t=>{try{t(this.state)}catch(s){console.error("Erro ao notificar subscriber",s)}})}getAreas(){return[...this.state.areas]}getAreaById(t){return this.state.areas.find(s=>s.id===t)}addArea(t){const s={id:`area_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,nome:t.nome,descricao:t.descricao||"",cor:t.cor||"#3b82f6",icone:t.icone||"ðŸ“š",status:"ativo",criadoEm:new Date().toISOString()};return this.state.areas.push(s),this.state.contadorAreas++,this._saveToFirestore(),this._notify(),s}updateArea(t,s){const e=this.state.areas.findIndex(o=>o.id===t);return e>=0?(this.state.areas[e]={...this.state.areas[e],...s},this._saveToFirestore(),this._notify(),this.state.areas[e]):null}removeArea(t){const s=this.state.areas.findIndex(e=>e.id===t);return s>=0?(this.state.areas.splice(s,1),this.state.contadorAreas--,this.state.topicos.forEach(e=>{e.areaId===t&&(e.areaId=null)}),this._saveToFirestore(),this._notify(),!0):!1}getTopicos(){return[...this.state.topicos]}getTopicoById(t){return this.state.topicos.find(s=>s.id===t)}getTopicosByArea(t){return this.state.topicos.filter(s=>s.areaId===t)}addTopico(t){const s={id:`topico_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,titulo:t.titulo,descricao:t.descricao||"",areaId:t.areaId||null,status:t.status||"NÃ£o iniciado",prioridade:t.prioridade||"MÃ©dia",tags:t.tags||[],tempoEstimado:t.tempoEstimado||null,sessoes:[],proximaRevisao:null,ultimaRevisao:null,historicoRevisoes:[],concluidoEm:null,criadoEm:new Date().toISOString()};return this.state.topicos.push(s),this.state.contadorTopicos++,this._saveToFirestore(),this._notify(),s}updateTopico(t,s){const e=this.state.topicos.findIndex(o=>o.id===t);if(e>=0){const o=this.state.topicos[e],i={...o,...s};return s.status==="ConcluÃ­do"&&o.status!=="ConcluÃ­do"&&this.revisaoEspacada&&this.revisaoEspacada.agendarRevisaoInicial(i),this.state.topicos[e]=i,this._saveToFirestore(),this._notify(),i}return null}removeTopico(t){const s=this.state.topicos.findIndex(e=>e.id===t);return s>=0?(this.state.topicos.splice(s,1),this.state.contadorTopicos--,this._saveToFirestore(),this._notify(),!0):!1}addSessao(t,s){const e=this.getTopicoById(t);if(!e)return null;const o={id:`sessao_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,data:s.data||new Date().toISOString(),duracao:s.duracao||0,notas:s.notas||"",tags:s.tags||[],dificuldade:s.dificuldade||3,recursos:s.recursos||[]};return e.sessoes||(e.sessoes=[]),e.sessoes.push(o),s.concluiu?(e.status="ConcluÃ­do",e.concluidoEm=o.data,this.revisaoEspacada&&this.revisaoEspacada.agendarRevisaoInicial(e)):e.status==="NÃ£o iniciado"&&(e.status="Estudando"),this._saveToFirestore(),this._notify(),o}getAllTags(){const t=new Set;return this.state.topicos.forEach(s=>{s.tags&&Array.isArray(s.tags)&&s.tags.forEach(e=>t.add(e))}),Array.from(t)}setRevisaoEspacada(t){this.revisaoEspacada=t}getState(){return{...this.state}}destroy(){this.listeners.forEach(t=>t()),this.listeners=[]}}typeof module<"u"&&module.exports&&(module.exports=n);export{n as EstudosStore,n as default};
//# sourceMappingURL=estudos-store-Cv7SF9pX.js.map
