import{i as $,g as m,a as A,e as O,c as C,d as K,b as R,q as p,w as D,o as P,f as q,s as S,h as F,j as Q,k as _,l as d,m as v}from"./firebase-DLTXyntu.js";import{f as c}from"./firebase-cache-CNydOCth.js";const b={apiKey:"",authDomain:"",projectId:"",storageBucket:"",messagingSenderId:"",appId:""};(!b.apiKey||!b.projectId)&&console.warn("‚ö†Ô∏è Firebase n√£o configurado. Usando modo offline apenas.");let w,g,E;try{w=$(b),g=m(w),E=A(w),O(g).catch(h=>{h.code==="failed-precondition"?console.warn("‚ö†Ô∏è Persist√™ncia offline do Firestore n√£o habilitada: m√∫ltiplas abas abertas"):h.code==="unimplemented"?console.warn("‚ö†Ô∏è Persist√™ncia offline do Firestore n√£o suportada neste navegador"):console.error("‚ùå Erro ao habilitar persist√™ncia offline:",h)}),console.log("‚úÖ Firebase inicializado com sucesso")}catch(h){console.error("‚ùå Erro ao inicializar Firebase:",h),g=null,E=null}const x="firebase-sync-queue",L=3;class T{constructor(){this.queue=[],this.isOnline=navigator.onLine,this.syncInProgress=!1,this.listeners=[],window.addEventListener("online",()=>this.handleOnline()),window.addEventListener("offline",()=>this.handleOffline()),this.loadQueue()}async loadQueue(){const e=await c.get(x);e&&Array.isArray(e)&&(this.queue=e)}async saveQueue(){await c.set(x,this.queue)}async addToQueue(e){this.queue.push({...e,timestamp:Date.now(),retries:0}),await this.saveQueue(),this.notifyListeners(),this.isOnline&&this.sync()}async sync(){if(this.syncInProgress||!this.isOnline||this.queue.length===0)return;this.syncInProgress=!0,this.notifyListeners();const e=[...this.queue],t=[],i=[];for(const s of e)try{await s.execute(),t.push(s)}catch(a){console.error("Erro ao sincronizar opera√ß√£o:",a),s.retries++,s.retries<L?i.push(s):console.warn("Opera√ß√£o falhou ap√≥s m√°ximo de tentativas:",s)}this.queue=i,await this.saveQueue(),this.syncInProgress=!1,this.notifyListeners(),t.length>0&&console.log(`‚úÖ ${t.length} opera√ß√£o(√µes) sincronizada(s)`),i.length>0&&console.warn(`‚ö†Ô∏è ${i.length} opera√ß√£o(√µes) falharam e ser√£o tentadas novamente`)}async handleOnline(){console.log("üåê Conex√£o restabelecida"),this.isOnline=!0,this.notifyListeners(),this.queue.length>0&&await this.sync()}handleOffline(){console.log("üì¥ Conex√£o perdida"),this.isOnline=!1,this.notifyListeners()}getOnlineStatus(){return this.isOnline}hasPendingOperations(){return this.queue.length>0}getPendingCount(){return this.queue.length}subscribe(e){return this.listeners.push(e),()=>{this.listeners=this.listeners.filter(t=>t!==e)}}notifyListeners(){this.listeners.forEach(e=>{try{e({isOnline:this.isOnline,hasPending:this.hasPendingOperations(),pendingCount:this.getPendingCount(),syncing:this.syncInProgress})}catch(t){console.error("Erro ao notificar listener:",t)}})}async clearQueue(){this.queue=[],await this.saveQueue(),this.notifyListeners()}}const u=new T;class z{constructor(){this.db=g,this.listeners=new Map,this.cachePrefix="firestore-"}isAvailable(){return this.db!==null}getCollectionRef(e){if(!this.isAvailable())throw new Error("Firestore n√£o est√° dispon√≠vel");return C(this.db,e)}getDocumentRef(e,t){if(!this.isAvailable())throw new Error("Firestore n√£o est√° dispon√≠vel");return K(this.db,e,t)}getCacheKey(e,t){return`${this.cachePrefix}${e}/${t}`}async getDocument(e,t){const i=this.getCacheKey(e,t);try{if(this.isAvailable()&&u.getOnlineStatus()){const s=this.getDocumentRef(e,t),a=await R(s);if(a.exists()){const r={id:a.id,...a.data()};return await c.set(i,r),r}}}catch(s){console.warn(`Erro ao ler documento do Firestore (${e}/${t}):`,s)}return await c.get(i)}async getCollection(e,t=[],i=null,s="asc"){try{if(this.isAvailable()&&u.getOnlineStatus()){let n=this.getCollectionRef(e);t.forEach(f=>{n=p(n,D(f.field,f.operator,f.value))}),i&&(n=p(n,P(i,s)));const o=await q(n),l=[];o.forEach(f=>{l.push({id:f.id,...f.data()})});const y=`${this.cachePrefix}collection-${e}`;return await c.set(y,l),l}}catch(n){console.warn(`Erro ao ler cole√ß√£o do Firestore (${e}):`,n)}const a=`${this.cachePrefix}collection-${e}`;return await c.get(a)||[]}async setDocument(e,t,i,s=!0){const a=this.getCacheKey(e,t),r={...i,updatedAt:new Date().toISOString()};if(await c.set(a,r),!u.getOnlineStatus())return await u.addToQueue({type:"set",collection:e,docId:t,data:r,merge:s,execute:async()=>this._executeSetDocument(e,t,r,s)}),t;try{return await this._executeSetDocument(e,t,r,s)}catch(n){throw console.error(`Erro ao salvar documento no Firestore (${e}/${t}):`,n),await u.addToQueue({type:"set",collection:e,docId:t,data:r,merge:s,execute:async()=>this._executeSetDocument(e,t,r,s)}),n}}async _executeSetDocument(e,t,i,s){if(!this.isAvailable())throw new Error("Firestore n√£o est√° dispon√≠vel");const{id:a,...r}=i;if(t){const n=this.getDocumentRef(e,t);return await S(n,{...r,updatedAt:d()},{merge:s}),t}else{const n=this.getCollectionRef(e);return(await F(n,{...r,createdAt:d(),updatedAt:d()})).id}}async updateDocument(e,t,i){return this.setDocument(e,t,i,!0)}async deleteDocument(e,t){const i=this.getCacheKey(e,t);if(await c.remove(i),!u.getOnlineStatus()){await u.addToQueue({type:"delete",collection:e,docId:t,execute:async()=>this._executeDeleteDocument(e,t)});return}try{await this._executeDeleteDocument(e,t)}catch(s){throw console.error(`Erro ao deletar documento do Firestore (${e}/${t}):`,s),await u.addToQueue({type:"delete",collection:e,docId:t,execute:async()=>this._executeDeleteDocument(e,t)}),s}}async _executeDeleteDocument(e,t){if(!this.isAvailable())throw new Error("Firestore n√£o est√° dispon√≠vel");const i=this.getDocumentRef(e,t);await Q(i)}async batchWrite(e){if(!this.isAvailable())throw new Error("Firestore n√£o est√° dispon√≠vel");const t=_(this.db);for(const i of e){const s=this.getDocumentRef(i.collection,i.docId);switch(i.type){case"set":t.set(s,{...i.data,updatedAt:d()},{merge:i.merge||!1});break;case"update":t.update(s,{...i.data,updatedAt:d()});break;case"delete":t.delete(s);break}}await t.commit()}subscribeToDocument(e,t,i){if(!this.isAvailable()){const n=this.getCacheKey(e,t);return c.get(n).then(i),()=>{}}const s=this.getDocumentRef(e,t),a=`${e}/${t}`,r=v(s,n=>{const o=n.exists()?{id:n.id,...n.data()}:null;if(o){const l=this.getCacheKey(e,t);c.set(l,o)}i(o)},n=>{console.error(`Erro ao escutar documento (${e}/${t}):`,n)});return this.listeners.set(a,r),()=>{r(),this.listeners.delete(a)}}subscribeToCollection(e,t,i=[]){if(!this.isAvailable()){const n=`${this.cachePrefix}collection-${e}`;return c.get(n).then(o=>t(o||[])),()=>{}}let s=this.getCollectionRef(e);i.forEach(n=>{s=p(s,D(n.field,n.operator,n.value))});const a=`collection-${e}`,r=v(s,n=>{const o=[];n.forEach(y=>{o.push({id:y.id,...y.data()})});const l=`${this.cachePrefix}collection-${e}`;c.set(l,o),t(o)},n=>{console.error(`Erro ao escutar cole√ß√£o (${e}):`,n)});return this.listeners.set(a,r),()=>{r(),this.listeners.delete(a)}}unsubscribeAll(){this.listeners.forEach(e=>e()),this.listeners.clear()}}const k=new z;export{k as f};
//# sourceMappingURL=firebase-service-DlA8zRSG.js.map
